# Span Tracing Fix - Parent Span ID Implementation

## Problem

The previous implementation incorrectly treated incoming `X-Span-Id` headers as the current service's span ID. This violated distributed tracing principles where each service should generate its own span ID.

**Incorrect behavior:**
- Service receives `X-Span-Id: sa1b2c3d4` from caller
- Service uses `sa1b2c3d4` as its own span_id
- No way to track parent-child span relationships

## Solution

Implemented proper parent-child span tracking:

1. **Incoming `X-Span-Id` becomes `parent_span_id`**
   - The receiving service reads `X-Span-Id` from the request header
   - This value is stored as `parent_span_id` in the RequestContext
   - Enables tracking of the calling service's span

2. **Each service generates its own `span_id`**
   - Every service always generates a NEW span_id for its operation
   - This span_id is unique to the current service's work
   - Logged alongside parent_span_id for hierarchy tracking

3. **Span source chain building**
   - `span_source` is built by appending to parent's `X-Span-Source`
   - Example: `GAPI:POST/api/orders->PULSE:POST/internal/orders->BROKER:POST/submit`
   - Shows the full call chain across services

## Changes Made

### 1. RequestContext (shared/observability/context.py)
- Added `parent_span_id: Optional[str]` field
- Updated `to_dict()` to include parent_span_id when present
- Added `Optional` import

### 2. ContextMiddleware (shared/observability/middleware.py)
- Reads incoming `X-Span-Id` as `parent_span_id`
- Always generates NEW `span_id` for current service
- Builds `span_source` by appending to parent's `X-Span-Source`
- Stores both `span_id` and `parent_span_id` in context

### 3. HTTP Client (shared/http/client.py)
- Updated documentation to clarify behavior
- Client sends current `span_id` as `X-Span-Id` header
- Receiving service treats this as `parent_span_id`

### 4. Documentation Updates
- `doc/standards/tracing.md` - Added parent_span_id concept and examples
- `doc/standards/context.md` - Updated RequestContext definition and examples

### 5. Tests
- Updated `tests/unit/shared/observability/test_context.py`
  - Added span_id generation and validation tests
  - Added parent_span_id tests
  - Updated RequestContext creation tests
- Created `tests/unit/shared/observability/test_span_propagation.py`
  - Tests span_id becomes parent_span_id across services
  - Tests span_source chain building
  - Tests response headers contain new span_id

## Example Flow

### Service A (GAPI) - First in chain
```
Request: No X-Span-Id header
Context created:
  span_id: sa1b2c3d4 (generated)
  parent_span_id: None
  span_source: GAPI:POST/api/orders
```

### Service B (PULSE) - Called by GAPI
```
Request headers from GAPI:
  X-Span-Id: sa1b2c3d4
  X-Span-Source: GAPI:POST/api/orders

Context created:
  span_id: sb2c3d4e5 (NEW, generated by PULSE)
  parent_span_id: sa1b2c3d4 (from X-Span-Id)
  span_source: GAPI:POST/api/orders->PULSE:POST/internal/orders
```

### Service C (BROKER) - Called by PULSE
```
Request headers from PULSE:
  X-Span-Id: sb2c3d4e5
  X-Span-Source: GAPI:POST/api/orders->PULSE:POST/internal/orders

Context created:
  span_id: sc3d4e5f6 (NEW, generated by BROKER)
  parent_span_id: sb2c3d4e5 (from X-Span-Id)
  span_source: GAPI:POST/api/orders->PULSE:POST/internal/orders->BROKER:POST/submit
```

## Benefits

1. **Proper distributed tracing**: Each service has its own span_id
2. **Parent-child relationships**: Can track which service called which
3. **Full call chain visibility**: span_source shows complete path
4. **Logging clarity**: Logs include both span_id and parent_span_id
5. **Standards compliance**: Follows OpenTelemetry-like span semantics

## Testing

All tests pass:
- 25 unit tests for observability (21 existing + 4 new)
- Integration tests for GAPI and PULSE services
- New tests specifically for span propagation behavior

## Migration Notes

**Breaking Change**: RequestContext now requires `span_id` and `span_source` parameters.

**Backward Compatibility**: `parent_span_id` is optional (defaults to None), so existing code that creates RequestContext will need to add the required fields but won't break if they don't use parent_span_id.

**Database Impact**: No changes needed. The `span_id` field already exists in database schemas. `parent_span_id` is only used for logging and tracing, not stored in the database.

