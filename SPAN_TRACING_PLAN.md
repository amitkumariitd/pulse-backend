# Span Tracing Implementation Plan

## Overview
Add `span_id` and `span_source` to the distributed tracing system to track individual operations within a request.

---

## Tracing Hierarchy

```
trace_id (end-to-end)
  └── request_id (synchronous request)
        └── span_id (individual operation/service call)
```

**Example Flow:**
```
GAPI receives request
  trace_id: t1735228800a1b2c3d4e5f6
  request_id: r1735228800f6e5d4c3b2a1
  span_id: sa1b2c3d4 (generated by GAPI middleware)
  span_source: GAPI:POST/api/orders

GAPI calls Pulse (HTTP)
  - Sends headers: X-Trace-Id, X-Request-Id, X-Span-Id,  X-Trace-Source, X-Request-Source, X-Span-Source  
  - Pulse middleware receives and generates NEW span_id

Pulse receives HTTP call
  trace_id: t1735228800a1b2c3d4e5f6 (same - from header)
  request_id: r1735228800f6e5d4c3b2a1 (same - from header)
  span_id: se5f6a1b2 (NEW - generated by Pulse middleware)
  span_source: GAPI:POST/api/orders->PULSE:POST/internal/orders (from header)

Pulse writes to DB
  - Regular table: only span_id, request_id
  - Async-initiating table: span_id + request_id + trace_id + trace_source
```

---

## Span ID Format

**Format:** `s` + 8 hexadecimal characters

**Example:** `sa1b2c3d4`

**Validation Pattern:** `^s[0-9a-f]{8}$`


---

## Span Source Format

**Format:** `CALLER_SERVICE:METHOD/path->TARGET_SERVICE:METHOD/path`

**Examples:**
- Initial span: `GAPI:POST/api/orders`
- HTTP call span: `GAPI:POST/api/orders->PULSE:POST/internal/orders`
- Nested call: `PULSE:POST/internal/orders->BROKER:POST/submit`

---

## Database Storage Rules

### Regular Tables (most tables)
**Store only:** `span_id`, `request_id`

**Rationale:** Minimal storage, sufficient for most tracing queries

**Example:**
```sql
CREATE TABLE orders (
    id VARCHAR(64) PRIMARY KEY,
    -- business columns...
    trace_id VARCHAR(64) NOT NULL,
    request_id VARCHAR(64) NOT NULL,
    tracing_source VARCHAR(50) NOT NULL,
    request_source VARCHAR(50) NOT NULL,
    span_id VARCHAR(16) NOT NULL,  -- NEW
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

### Async-Initiating Tables (tables that trigger async processing)
**Store:** `span_id`, `request_id`, `trace_id`, `trace_source`

**Rationale:** Async processes need trace context to continue the distributed trace

**Example:**
```sql
CREATE TABLE order_events (
    id VARCHAR(64) PRIMARY KEY,
    -- business columns...
    trace_id VARCHAR(64) NOT NULL,
    trace_source VARCHAR(50) NOT NULL,
    request_id VARCHAR(64) NOT NULL,
    request_source VARCHAR(50) NOT NULL,
    span_id VARCHAR(16) NOT NULL,  -- NEW
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

---

## HTTP Propagation

**Outbound HTTP calls (sender side):**
1. HTTP client receives current RequestContext
2. Propagates existing tracing headers: `X-Trace-Id`, `X-Trace-Source`, `X-Request-Id`, `X-Request-Source`
3. Propagates current span info: `X-Span-Id`, `X-Span-Source`
4. Does NOT generate new span_id (receiver will do this)

**Inbound HTTP calls (receiver side):**
1. Middleware extracts tracing headers from request
2. Generates NEW `span_id` for this service's operation
3. Extracts `X-Span-Source` from header OR generates from current request_source
4. Attaches to RequestContext

---

## Logging

**All logs include:**
- `trace_id`, `trace_source`
- `request_id`, `request_source`
- `span_id`, `span_source` (NEW)

**Example log entry:**
```json
{
  "timestamp": "2024-12-28T10:30:00Z",
  "level": "INFO",
  "service": "pulse",
  "message": "Order created",
  "trace_id": "t1735228800a1b2c3d4e5f6",
  "trace_source": "GAPI:POST/api/orders",
  "request_id": "r1735228800f6e5d4c3b2a1",
  "request_source": "PULSE:POST/internal/orders",
  "span_id": "se5f6a1b2",
  "span_source": "GAPI:POST/api/orders->PULSE:POST/internal/orders",
  "data": {"order_id": "ord-123"}
}
```

---

## Implementation Tasks

1. ✅ **Documentation** - Update tracing.md with span concepts
2. ✅ **Core Context** - Add span_id/span_source to RequestContext
3. ✅ **Middleware** - Extract/generate span_id in ContextMiddleware
4. ✅ **HTTP Client** - Generate new span_id for outbound calls
5. ✅ **Logger** - Include span fields in all logs
6. ✅ **Database Standards** - Document span_id storage rules
7. ✅ **Examples** - Update SQL/Python examples

---

## Benefits

✅ **Fine-grained tracing** - Track individual operations within a request
✅ **Service call visibility** - See exact path through services
✅ **Performance analysis** - Measure latency of specific operations
✅ **Debugging** - Isolate which service call caused an issue
✅ **Async correlation** - Connect async processes back to originating span

